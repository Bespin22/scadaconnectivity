<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCADA ‚Äì IP Connectivity Monitoring</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<!-- ================= HEADER ================= -->
<header>
  <h1>SCADA Connectivity Application</h1>
  <nav>
    <button onclick="showSection('home')">Home</button>
    <button onclick="showSection('ip-management')">IP Management</button>
  </nav>
</header>

<!-- ================= HOME ================= -->
<section id="home" class="section">
  <h2>Home ‚Äì Turbine Connectivity</h2>

  <label for="location-filter">Filter by Turbine Location:</label>
  <select id="location-filter">
    <option value="all">All Turbine Locations</option>
  </select>

  <div id="home-status" class="box-container">
    Loading turbine status...
  </div>
</section>

<!-- ================= IP MANAGEMENT ================= -->
<section id="ip-management" class="section hidden">
  <h2>IP Management</h2>

  <!-- Add IP -->
  <h3>Add New IP</h3>
  <form id="add-ip-form" class="form-container">
    <input type="text" id="ipName" placeholder="Turbine Name" required />
    <input type="text" id="ipAddress" placeholder="IP Address" required />
    <input type="text" id="ipTurbineType" placeholder="Turbine Type" required />
    <input type="text" id="ipTurbineLocation" placeholder="Turbine Location" required />
    <button type="submit">Add IP</button>
  </form>

  <!-- Bulk Upload -->
  <h3>Bulk Upload (Excel)</h3>
  <form id="bulk-upload-form">
    <input type="file" id="bulkFile" accept=".xlsx" required />
    <button type="submit">Upload</button>
  </form>

  <!-- Download -->
  <h3>Download</h3>
  <button id="download-ip-list">Download IP List (XLSX)</button>

  <!-- IP List -->
  <h3>Active IP List</h3>
  <div id="ip-list" class="box-container">
    Loading IP list...
  </div>

  <!-- Deleted IPs -->
  <h3>Deleted IPs</h3>
  <div id="deleted-ips" class="box-container">
    Loading deleted IPs...
  </div>
</section>

<!-- ================= SCRIPT ================= -->
<script>
const API_BASE_URL = "http://localhost:3000";
let ipData = [];

/* ---------- Navigation ---------- */
function showSection(sectionId) {
  document.querySelectorAll(".section").forEach(sec =>
    sec.classList.add("hidden")
  );
  document.getElementById(sectionId).classList.remove("hidden");
}

/* ---------- Load Ping Data ---------- */
async function loadPingData() {
  const res = await fetch(`${API_BASE_URL}/ping`);
  ipData = await res.json();

  renderHome(ipData);
  renderIPList(ipData);
  populateLocationFilter(ipData);
}

/* ---------- Home ---------- */
function renderHome(data) {
  const homeDiv = document.getElementById("home-status");
  homeDiv.innerHTML = data.map(ip => `
    <div class="box ${ip.status === "Connected" ? "connected" : "disconnected"}">
      <p><strong>${ip.name}_${ip.turbineType}</strong></p>
      <p>${ip.turbineLocation}</p>
      <p>Status: ${ip.status}</p>
    </div>
  `).join("");
}

/* ---------- Filter ---------- */
function populateLocationFilter(data) {
  const dropdown = document.getElementById("location-filter");
  const locations = [...new Set(data.map(d => d.turbineLocation))];

  dropdown.innerHTML = '<option value="all">All Turbine Locations</option>';
  locations.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc;
    opt.textContent = loc;
    dropdown.appendChild(opt);
  });
}

document.getElementById("location-filter").addEventListener("change", () => {
  const value = document.getElementById("location-filter").value;
  const filtered = value === "all"
    ? ipData
    : ipData.filter(ip => ip.turbineLocation === value);

  renderHome(filtered);
});

/* ---------- IP List ---------- */
function renderIPList(data) {
  const div = document.getElementById("ip-list");
  div.innerHTML = data.map(ip => `
    <div class="box">
      <p><strong>Name:</strong> ${ip.name}</p>
      <p><strong>IP:</strong> ${ip.ip}</p>
      <p><strong>Type:</strong> ${ip.turbineType}</p>
      <p><strong>Location:</strong> ${ip.turbineLocation}</p>
      <button onclick="editIP('${ip.name}','${ip.ip}','${ip.turbineType}','${ip.turbineLocation}')">‚úèÔ∏è Edit</button>
      <button onclick="deleteIP('${ip.ip}')">üóëÔ∏è Delete</button>
    </div>
  `).join("");
}

/* ---------- Deleted IPs ---------- */
async function fetchDeletedIPs() {
  const res = await fetch(`${API_BASE_URL}/deleted-ips`);
  const data = await res.json();

  document.getElementById("deleted-ips").innerHTML = data.map(ip => `
    <div class="box">
      <p>${ip.name}_${ip.turbineType}</p>
      <p>${ip.ip}</p>
      <button onclick="restoreIP('${ip.ip}')">‚ôªÔ∏è Restore</button>
      <button onclick="permanentlyDeleteIP('${ip.ip}')">‚ùå Delete</button>
    </div>
  `).join("");
}

/* ---------- Add IP ---------- */
document.getElementById("add-ip-form").addEventListener("submit", async e => {
  e.preventDefault();

  const payload = {
    name: ipName.value,
    ip: ipAddress.value,
    turbineType: ipTurbineType.value,
    turbineLocation: ipTurbineLocation.value
  };

  const res = await fetch(`${API_BASE_URL}/add-ip`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    alert("IP added successfully");
    e.target.reset();
    loadPingData();
  } else {
    const err = await res.json();
    alert(err.message);
  }
});

/* ---------- Bulk Upload ---------- */
document.getElementById("bulk-upload-form").addEventListener("submit", async e => {
  e.preventDefault();

  const file = bulkFile.files[0];
  const fd = new FormData();
  fd.append("file", file);

  const res = await fetch(`${API_BASE_URL}/bulk-add`, {
    method: "POST",
    body: fd
  });

  const result = await res.json();
  alert(
    `Bulk Upload Finished
Added: ${result.added}
Duplicates: ${result.duplicates}
Skipped: ${result.skipped}`
  );

  loadPingData();
});

/* ---------- Download ---------- */
document.getElementById("download-ip-list").onclick = () => {
  window.location.href = `${API_BASE_URL}/export-turbines`;
};

/* ---------- Edit / Delete / Restore ---------- */
async function editIP(name, ip, type, loc) {
  const newName = prompt("Name", name);
  const newIp = prompt("IP", ip);
  const newType = prompt("Turbine Type", type);
  const newLoc = prompt("Location", loc);

  if (!newName || !newIp) return;

  await fetch(`${API_BASE_URL}/edit-ip`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      oldIp: ip,
      name: newName,
      ip: newIp,
      turbineType: newType,
      turbineLocation: newLoc
    })
  });

  loadPingData();
}

async function deleteIP(ip) {
  await fetch(`${API_BASE_URL}/delete-ip/${ip}`, { method: "DELETE" });
  loadPingData();
  fetchDeletedIPs();
}

async function restoreIP(ip) {
  await fetch(`${API_BASE_URL}/restore-ip/${ip}`, { method: "POST" });
  loadPingData();
  fetchDeletedIPs();
}

async function permanentlyDeleteIP(ip) {
  await fetch(`${API_BASE_URL}/permanently-delete-ip/${ip}`, { method: "DELETE" });
  fetchDeletedIPs();
}

/* ---------- INIT ---------- */
loadPingData();
fetchDeletedIPs();
</script>

</body>
</html>
